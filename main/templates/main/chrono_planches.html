{% extends "base.html" %}

{% block javascript %}

<style>

#date_du_jour
{
    position:absolute;
    width: 2px;
    background: white;
    border: 2px solid blue;   
}

.nouveau_plant
{
display:none;
}

.chrono_serie
    {
    width: 30%;
    height: 75px;
    background: white;
    color: black;
    border: 5px solid green;
    position:relative;
    }
    
.evt
{
    background: orange;
    position:absolute;
    height:13px;
}
.suppr_planche
{
display:inline;
}

#divDeplacementSerie
    {
    text-align:left;
    padding:10px;
    width: 400px;
    height: 25	0px;
    background: white;
    color: black;
    border: 5px solid brown;
    border-radius:10px;
    position: absolute;
    display:none;
    }  
      
</style>

    <script type="text/javascript" src="{{ STATIC_URL }}javascripts/myTools.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}javascripts/moment-with-locales.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}javascripts/planif.js"></script>

    <script type="text/javascript">
    
    s_info = ""
    date_debut_vue = "{{date_debut_vue|safe}}"
    date_fin_vue = "{{date_fin_vue|safe}}"
    date_du_jour = "{{date_du_jour|safe}}"
    decalage_j = {{decalage_j|safe}}
    // evenement par serie id
    l_evts_plants=[    {% for planche in l_planches %}{% for serie in planche.l_plants %}
			{% for evt in serie.l_evts %}  {"id":"{{evt.id}}",
											"nom":"{{evt.nom}}",
											"date":"{{evt.date|safe}}",
											"duree_j":"{{evt.duree_j}}",
											"type":"{{evt.type}}",
											"id_serie":"{{evt.serie_id}}"}{% if not forloop.last %},{% endif %}{% endfor%}
		{% endfor %}{% endfor %}]

function    init()
    {
    o_nomTypeEvt = {{d_evtTypes|safe}}

    changelePas(0) // juste pour affichage 1 ere fois

    // nb px par jour en fonction des bornes , on ajoute 1 pour inclure le dernier jour plein 
    pxParH = window.getComputedStyle(document.getElementsByClassName("cadre_chrono")[0]).width.split('px')[0] / moment(date_fin_vue).diff(moment(date_debut_vue), 'hours')

    balisageSeries()
    
    // ajout ligne date du jour
    delta_h = moment(date_du_jour).diff(moment(date_debut_vue), 'hours')
    
    l_planches = document.getElementsByClassName("cadre_chrono")
    for (ii=0;ii<l_planches.length;ii++)
    	{
    	hBarreJour = l_planches[ii].getElementsByClassName("barre_du_jour")[0]
	    hBarreJour.style.height = window.getComputedStyle(l_planches[ii]).height
	    hBarreJour.style.marginLeft = delta_h * pxParH + "px" 
	    }
	    
    }


function  deplacement(hForm)
    {
	// déplacement d'une serie vers une autre planche 
    s_request = "cde=deplacement_serie&id_serie=" + document.getElementById("deplacement_id_serie").value
    s_request += "&id_planche_src=0"
    s_request += "&num_planche_dest=" + document.getElementById("deplacement_num_planche_dest").value
    s_request += "&nb_rangs=" + document.getElementById("deplacement_nb_rangs").value
    s_request += "&intra_rang_cm=" + document.getElementById("deplacement_intra_rang_cm").value
    s_request += "&partiel=" + document.getElementById("deplacement_partiel").checked
    s_request += "&nb_plants=" + document.getElementById("deplacement_nb_plants").value
    b_simu = document.getElementById("deplacement_simulation").checked
    s_request += "&simulation=" + b_simu
    rep = requestServer(s_request)  
    jsonRep = JSON.parse(rep)
    if (jsonRep.status == 'true')
        {
        document.getElementById("divDeplacementSerie").style.display = "none"
      	alert(jsonRep.msg)
        window.location.reload()
        }
    else
    	document.getElementById("divInfoDebug").innerHTML = jsonRep.err
    }
    
function  balisageSeries()
    {
    l_series = document.getElementsByClassName("chrono_serie")
    for (ii=0; ii<l_series.length; ii++)
        {
        // decalage debut
        debut = l_series[ii].getAttribute("date_debut")
        deltaH = moment(debut).diff(moment(date_debut_vue), 'hours')
        l_series[ii].style.marginLeft = deltaH * pxParH + "px" 
        // decalage fin
        fin = l_series[ii].getAttribute("date_fin")
        deltaH = moment(fin).diff(moment(debut), "hours")
        l_series[ii].style.width = deltaH * pxParH  + "px"
        // placement des évenements "divers"
        s_evt = ""
    	for (jj=0;jj<l_evts_plants.length;jj++)
    		{
    		if (l_evts_plants[jj]["id_serie"] != l_series[ii].getAttribute("id"))
    			continue
            //positionnement des évènements
            deltaPx = moment(l_evts_plants[jj]["date"]).diff(moment(debut), 'hours') * pxParH
            s_evt += "<div class='evt' style='left:" + deltaPx + "px;width:" + l_evts_plants[jj]["duree_j"] * 24 * pxParH + "px;' title='" + l_evts_plants[jj]["nom"] + '\n' + moment(l_evts_plants[jj]["date"]).format("DD/MM/YYYY") + "' > </div>"
            //s_evt = "<div style='position:absolute'><img title='" + l_evts_plants[jj]["nom"] + '\n' + moment(l_evts_plants[jj]["date"]).format("DD/MM/YYYY") + "' src='{{STATIC_URL}}images/puce.png' style='margin-left:" + deltaPx + "px;width:" + l_evts_plants[jj]["duree_j"] * 24 * pxParH + "px;height:13px'></div>"
            }
        document.getElementById(l_series[ii].getAttribute("id")).getElementsByClassName("evts")[0].innerHTML = s_evt
        }
    }


 
function ajouteEvenement() 
    {
    document.getElementById("editeSerie_evts").innerHTML += '<table><tr><td>Nom : <input type="hidden" value="0" name="edit_evt_id[]"/><input type="text" value="" name="edit_evt_nom[]"/></td></tr><tr><td>Date : (jj/mm/aaaa): <input style="width: 100px" type="text" value="" name="edit_evt_date[]"/></td></tr><tr><td>Durée max (j): <input style="width: 60px" type="text" value="1" name="edit_evt_duree_j"/></td></tr></table>'
    }

function supprimeSerie(id_serie)
    {
    s_request = "cde=supprime_serie&id=" + id_serie
    alert(s_request)
    rep = requestServer(s_request)  
    jsonRep = JSON.parse(rep)   
    if (jsonRep.status == 'true')
        window.location.reload()    
    else
        alert(jsonRep.err)
    }



function prepareAjouteSerie(hCaller, num_planche)
    {
    hDiv = document.getElementById("divEditSerie")
    hDiv.style.display = "block"
    hDiv.style.position = "absolute"
    hDiv.style.left = "10px"
    hDiv.style.top = hCaller.offsetTop + "px" // decale à la hauteur de la planche à garnir
    document.getElementById("editSerie_num_planche").value = num_planche
    document.getElementById("editSerie_id_serie").value = 0
    document.getElementById("editSerie_id_serie").readOnly = true
    document.getElementById("editSerie_titre").innerHTML = "Edition d'une nouvelle série"
    }
    
function prepareEditeSerie(id_serie)
    {
    hDiv = document.getElementById("divEditSerie")
    hDiv.style.display = "block"
    hDiv.style.position = "absolute"
    hDiv.style.left = "10px"
    hDivSerie = document.getElementById(id_serie)
    hDiv.style.top = hDivSerie.offsetTop + 80 + "px" // 80 pour aller en dessous du div de serie
    document.getElementById("editSerie_id_serie").value = hDivSerie.getAttribute("id")
    document.getElementById("editSerie_id_serie").readOnly = true
    document.getElementById("editSerie_num_planche").value =  hDivSerie.getAttribute("num_planche")
    document.getElementById("editSerie_nb_rangs").value = hDivSerie.getAttribute("nb_rangs")
    document.getElementById("editSerie_intra_rang_cm").value = hDivSerie.getAttribute("intra_rang_cm")
    document.getElementById("editSerie_quantite").value = hDivSerie.getAttribute("quantite")
    document.getElementById("editSerie_date_debut").value = hDivSerie.getAttribute("date_debut_f")
    document.getElementById("editSerie_date_fin").value = hDivSerie.getAttribute("date_fin_f")
    // maj variété
    id_variet  = hDivSerie.getAttribute("id_variete")
    list = document.getElementById("editSerie_id_variete").getElementsByTagName("option")
    for(ii=0;ii<list.length;ii++)
        if (list[ii].id == id_variet)
            {
            document.getElementById("editSerie_id_variete").options[ii].selected=true
            break
           }
    document.getElementById("editSerie_titre").innerHTML = "Edition d'une série"

    }

function prepareDeplacementSerie(id_serie)
    {
    hDiv = document.getElementById("divDeplacementSerie")
    hDiv.style.display = "block"
    hDiv.style.position = "absolute"
    hDiv.style.left = "10px"
    hDivSerie = document.getElementById(id_serie)
    hDiv.style.top = hDivSerie.offsetTop + 80 + "px" // 80 pour aller en dessous du div de serie
    document.getElementById("deplacement_id_serie").value = hDivSerie.getAttribute("id")
    document.getElementById("deplacement_num_planche_orig").value =  hDivSerie.getAttribute("num_planche")
    document.getElementById("deplacement_nb_rangs").value = hDivSerie.getAttribute("nb_rangs")
    document.getElementById("deplacement_intra_rang_cm").value = hDivSerie.getAttribute("intra_rang_cm")
    document.getElementById("deplacement_quantite").value = hDivSerie.getAttribute("quantite")
   
    }

                                       
function sauveSerie()
    {
    // sauvegarde d'une serie
    s_request = "cde=sauve_serie&id_serie=" + document.getElementById("editSerie_id_serie").value
    s_request += "&id_variete=" + document.getElementById("editSerie_id_variete").value
    s_request += "&num_planche=" + document.getElementById("editSerie_num_planche").value
    s_request += "&nb_rangs=" + document.getElementById("editSerie_nb_rangs").value
    s_request += "&intra_rang_cm=" + document.getElementById("editSerie_intra_rang_cm").value
    s_request += "&quantite=" + document.getElementById("editSerie_quantite").value
    s_request += "&date_debut=" + document.getElementById("editSerie_date_debut").value
    s_request += "&date_fin=" + document.getElementById("editSerie_date_fin").value

    rep = requestServer(s_request)  
    jsonRep = JSON.parse(rep)
    if (jsonRep.status == 'true')
        {
        alert(jsonRep.msg)
        window.location.reload()
        }
    else
        document.getElementById("divInfoDebug").innerHTML = jsonRep.err

    }
           
function editePlant(hPlant)
    {
    // recup evenements liés à cette série
    id_serie = hPlant.getAttribute("id_serie")
    
    if (id_serie.search("_") != 1)
        majListEvts(id_serie)
        
    // maj variété
    id_variet  = hPlant.getAttribute("variete")
    list = document.getElementById("editeSerie_select_var").getElementsByTagName("option")
    for(ii=0;ii<list.length;ii++)
        if (list[ii].value == id_variet)
            {
            document.getElementById("editeSerie_select_var").options[ii].selected=true
            break
           }

    // maj attributs série               
    document.getElementById("editeSerie_id_planche").innerHTML = {{planche.num}}
    document.getElementById("editeSerie_plantId").innerHTML = id_serie
    document.getElementById("editeSerie_quantite").value = hPlant.getAttribute("quantite")
    document.getElementById("editeSerie_date_debut").value =  hPlant.getAttribute("date_debut")
    document.getElementById("editeSerie_date_fin").value =  hPlant.getAttribute("date_fin")
    document.getElementById("divEditSerie").style.display = "inline"
    }

</script>

{% endblock %}

{% block title %}Suivi temporel des series sur les planches{% endblock %}

{% block content %}
{{s_msg}}

<p id="divInfoDebug"> </p>

<div id="main" style="text-align: center" >

<form action="" method="POST" accept-charset="utf-8">
{% csrf_token %}
<input hidden type="text" id="mode" value="echelle" />
Pour les planches <input style="width: 300px" type="text" name="noms_planches" value="{% for planche in l_planches %}{{planche.nom}},{% endfor %}" />
 Visionnage du      <input style="width: 100px" type="text" name="date_debut_vue" value="{{date_debut_vue|date:'d/m/Y'}}" /> au <input style="width: 100px" type="text" name="date_fin_vue" value="{{date_fin_vue|date:'d/m/Y'}}" />
                    <input style="margin-left: 20px" type="submit" value="Envoyer" />
                    <input style="margin-left: 20px" type="submit" name="direction" value="recul" />
<input type="submit" name="direction" value="avance" />
Pas de <input style="width: 50px" type="text" id="decalage_j" name="decalage_j" value="{{decalage_j}}" /> jours 
<button onclick="changelePas(-1);return(false)">-</button><button onclick="changelePas(1);return(false)">+</button>


<br/><br/>
    {% for planche in l_planches %}
	<br/>
    <div id="cadre_chrono_pl{{planche.id}}" class="cadre_chrono">
    <div class="barre_du_jour"> </div>
   
    <h2>{{planche}}
        <img src="{{STATIC_URL}}images/plus.png" title="Ajouter une série" onclick="prepareAjouteSerie(this, {{planche.num}});return false"> 
           
    </h2>

        {# séries existantes en base #}
        {% for serie in planche.l_series %}
        <div class="chrono_serie"   id="{{serie.id}}" num_planche="{{planche.num}}" 
                                    nom_variete="{{serie.variete}}" id_variete="{{serie.variete.id}}" 
                                    quantite="{{serie.quantite}}"
                                    date_debut="{{serie.evt_debut.date|safe}}" date_fin="{{serie.evt_fin.date|safe}}"
                                    date_debut_f="{{serie.evt_debut.date|date:'d/m/Y'}}" date_fin_f="{{serie.evt_fin.date|date:'d/m/Y'}}"
                                    nb_rangs="{{serie.nb_rangs}}" intra_rang_cm="{{serie.intra_rang_cm}}"
                                    style="border-color: {{serie.variete.couleur}}" >
                                    
        <img width="20" heigth="20" src="{{STATIC_URL}}images/Help.png" title="id={{serie.id}} planche={{planche.num}} &#13;variete={{serie.variete}} quantite={{serie.quantite}} &#13; nb_rangs={{serie.nb_rangs}} intra_rang_cm={{serie.intra_rang_cm}}&#13;longueur : {{serie.longueurSurPlanche_m|floatformat:'1'}}m surface : {{ serie.surfaceSurPlanche_m2|floatformat:'0' }} m2 &#13; Du {{serie.evt_debut.date|date:'d/m/Y'}} au {{serie.evt_fin.date|date:'d/m/Y'}}"  />
        <div class="num_plant" style="display: inline;z-index:3;  ">({{serie.id}}) </div>
        <div class="variete" style="display: inline;z-index:3; ">
        {{serie.variete}} x {{serie.quantite}}</div>
        <a href="#" onclick="javascript:prepareEditeSerie({{serie.id}});return(false)">EDITER</a>
        <a href="#" onclick="javascript:prepareDeplacementSerie({{serie.id}});return(false)">DEPLACER</a><br/>
        <div class="debut" style="display: inline;float:left">{{serie.evt_debut.date|date:'d/m/Y'}}</div><br/>
        <div class="fin" style="display:inline;float:right">{{serie.evt_fin.date|date:'d/m/Y'}}</div><br/>
        <div class="evts" style="display:inline;position:relative;float:left;"> </div>
        </div>
        {% endfor %}
    </div>
    {% endfor %}


	<div id="divEditSerie" style="display:none" class="BlueFrame" >
		<h2 id="editSerie_titre"> </h2>
		<p>
		Série <input style="width:40px" type="text" id="editSerie_id_serie"  name="editSerie_id_serie" value="" />
		sur planche N° <input style="width: 40px" type="text" id="editSerie_num_planche" name="editSerie_num_planche" value="0" /></p>
	    <p>Variété : <select id="editSerie_id_variete" name="editSerie_id_variete" >
	    			{% for var in l_vars %}
	    	        <option value="{{var.id}}" id="{{var.id}}" name="{{var.id}}">{{var.nom|title}}</option>
	    	    	{% endfor %}
	    	      </select>
	    </p>
        <p>Quantité :               <input style="width: 40px" type='text' value="" id="editSerie_quantite"  name="editSerie_quantite" /></p>
        <p>Nb rangs :               <input style="width: 40px" type='text' value="" id="editSerie_nb_rangs"  name="editSerie_nb_rangs" />
           Dans le rang (cm) :      <input style="width: 40px" type='text' value="" id="editSerie_intra_rang_cm"  name="editSerie_intra_rang_cm" /></p>
	    <p>Début (jj/mm/aa) :       <input style="width:100px" type="text" value="" id="editSerie_date_debut" name="editSerie_date_debut"/></p>
	    <p>Fin (jj/mm/aa) ou vide : <input style="width:100px" type="text" value="" id="editSerie_date_fin"  name="editSerie_date_fin" /></p>
	    <br/><b>Evenements</b>
	    <div id="editeSerie_evts"> </div>
	    <input type='button' value='+' onclick="ajouteEvenement()"/><br/>
	    <hr/>
        <input type='button' value='Supprimer' name='supprime' onclick="supprimeSerie(document.getElementById('editSerie_id_serie').value)"/>
        <input type='button' value='Fermer' name='annule' onclick="document.getElementById('divEditSerie').style.display='none';return False"/>
	    <input type='button' value='Sauver' onclick="sauveSerie();return False" /><br/>
	</div>
    </form>
    
    <div id="divDeplacementSerie">
        <h3>Déplacement de la série N°<input id="deplacement_id_serie"         value="" type="text" readonly style="width: 30px;margin-left: 10px;display:inline" /></h3>
        Nb de série :               <input id="deplacement_quantite"           value="" type="text" readonly style="width: 30px" /><br/>
        De la planche N°            <input id="deplacement_num_planche_orig"   value="" type="text" readonly style="width: 30px;margin-left: 10px"/>
        vers la planche N°          <input id="deplacement_num_planche_dest"   value="" type="text"          style="width: 30px;margin-left: 10px"/><br/>
        dans le rang (cm)           <input id="deplacement_intra_rang_cm"      value="" type="text"          style="margin-left: 10px;width: 30px"/><br/>
        Nombre de rangs             <input id="deplacement_nb_rangs"           value="" type="text"          style="margin-left: 10px;width: 30px"/><br/>
        Déplacement partiel         <input id="deplacement_partiel"                     type="checkbox" />
        Nb de plants :              <input id="deplacement_nb_plants"          value="" type="text" style="width: 30px" /><br/>
        Simulation                  <input id="deplacement_simulation"                  type="checkbox" />
        <input type="submit" value="Déplacement" onclick="deplacement(this)" style="margin-left: 30px" />
        <input type='button' value='Fermer' name='annule' onclick="document.getElementById('divDeplacementSerie').style.display='none';return False"/>
        
    </div>

</div>

{% endblock %}
