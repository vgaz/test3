{% extends "base.html" %}
{% load static %}
{% block pagetitle %}Récoltes estimées{% endblock %}
{% block javascript %}
<script type="text/javascript" src="{% static 'javascripts/myTools.js' %}"> </script>
<script type="text/javascript" >

l_sems = [{% for sem in l_semaines %}"{{sem.date_debut|date:'Y-m-d'}}"{% if not forloop.last %},{% endif %}{% endfor %}]
l_legs = [{% for leg in l_legumes %}{{leg.id}}{% if not forloop.last %},{% endif %}{% endfor %}]
l_especes = [{% for esp in l_especes %}{{esp.id}}{% if not forloop.last %},{% endif %}{% endfor %}]
l_couleur_esp = { {% for esp in l_especes %}{{esp.id}}:"{{esp.couleur}}"{% if not forloop.last %},{% endif %}{% endfor %}}
l_parts_esp = { {% for esp in l_especes %}{{esp.id}}:"{{esp.nbParts}}"{% if not forloop.last %},{% endif %}{% endfor %}}
nbPanniers = {{nbPanniers}}

function enregistreRecolte(ptDiv)
    {
    divRecLeg = document.getElementById("r__sem_" + ptDiv.getAttribute("date") + "__leg_" + ptDiv.getAttribute("leg"))
    rep = requestServer("cde=enregistre_recolte&date_sem=" + ptDiv.getAttribute("date") + "&id_leg=" + ptDiv.getAttribute("leg") + "&qte=" + divRecLeg.value)
    }

function init()
    {
    montre_especes()
    
    // maj tableau légumes 
    cumulTotal = 0       
    for (ii=0;ii<l_sems.length;ii++)
        {
        cumul = 0
        for (jj=0;jj<l_legs.length;jj++)
            {
            poidsL = parseInt(document.getElementById("sem_" + l_sems[ii] + "__leg_" + l_legs[jj]).getAttribute("poids"))
            cumul += poidsL
            //alert("sem:" + l_sems[ii] + " leg:" + l_legs[jj] + " poidsL:" + poidsL +" cumul:" + cumul)
            }
        document.getElementById("ts_" + l_sems[ii]).innerHTML = cumul
        document.getElementById("tlpp_" + l_sems[ii]).innerHTML = cumul/nbPanniers
        cumulTotal += cumul
        }   
    document.getElementById("totalTotal").innerHTML = cumulTotal
    
    // total par légume (kg)
    for (ll=0; ll<l_legs.length; ll++)
        {
        cumul = 0
        for (ss=0;ss<l_sems.length;ss++)
            cumul += parseInt(document.getElementById("sem_" + l_sems[ss] + "__leg_" + l_legs[ll]).getAttribute("qte"))
        document.getElementById("tl_" + l_legs[ll]).innerHTML = cumul
        }


    // total par espèce pour chaque semaine   
    for (ee=0; ee<l_especes.length; ee++)
        {
        cumulTETS = 0 // 
        for (ss=0;ss<l_sems.length;ss++)
            {
            cumulEPS = 0
            for (ll=0;ll<l_legs.length;ll++)
                {
                divLeg = document.getElementById("sem_" + l_sems[ss] + "__leg_" + l_legs[ll])
                esp_id = parseInt(divLeg.getAttribute("esp_id"))
                if( esp_id != l_especes[ee])
                    continue
                qte = parseInt(divLeg.getAttribute("qte"))
                cumulEPS += qte
                cumulTETS += qte
                }

            id =  document.getElementById("sem_" + l_sems[ss] + "__esp_" + l_especes[ee])
            id.innerHTML = cumulEPS
            if (cumulEPS >0)
                { 
                id.style.border = "5px solid " + l_couleur_esp[l_especes[ee]]
                id.style.textAlign="center"
                }
            else
                id.style.display = "none"    
            }
        document.getElementById("tets_" + l_especes[ee]).innerHTML = cumulTETS
        }   
        
        // total par semaine pour chaque espece (en Kg) et liste des espèces dont le poids est non nul
        total_etets = 0
        for (ss=0; ss<l_sems.length; ss++)
            {
            s_listeEsp = ""
            poids_SPE = 0 // total de chaque semaine
            for (ee=0; ee<l_especes.length; ee++)
                {
                poidsLegs = 0
                for (ll=0;ll<l_legs.length;ll++)
                    {
                    divLeg = document.getElementById("sem_" + l_sems[ss] + "__leg_" + l_legs[ll])
                    esp_id = parseInt(divLeg.getAttribute("esp_id"))
                    if( esp_id != l_especes[ee])
                        continue
                    poidsLeg = parseInt(divLeg.getAttribute("poids"))
                    poidsLegs += poidsLeg
                    if (poidsLeg != 0)
                        {
                        nom = divLeg.getAttribute("esp_nom")
                        if (s_listeEsp.indexOf(nom) == -1)
                            s_listeEsp += "<br/>" + nom
                        }
                   }        
                poids_SPE += poidsLegs
                }
            document.getElementById("tets_" + l_sems[ss]).innerHTML = poids_SPE
            document.getElementById("tepspp_" + l_sems[ss]).innerHTML = poids_SPE / nbPanniers + " kg"
            document.getElementById("cont_pspp_" + l_sems[ss]).innerHTML = s_listeEsp
            total_etets += poids_SPE
            }           
        document.getElementById("total_etets").innerHTML = total_etets
    }
    
    
function montre_legumes()
    {
    document.getElementById('tab_legumes').style.display='block'
    document.getElementById('tab_especes').style.display='none'   
    }
    
function montre_especes()
    {
    document.getElementById('tab_legumes').style.display='none'
    document.getElementById('tab_especes').style.display='block'
    }
    
</script>

{% endblock %}

{% block title %}Prévision de récoltes et livraisons par semaine{% endblock %}

{% block content %}

    <p id="divInfoDebug"> </p>
    
    
    <form action="" method="POST" accept-charset="utf-8">
    {% csrf_token %}
    <div class="BlueFrame" style="width:90%;display:block">
    
        Par pas de <input style="width: 30px" type="text" id="decalage_j" name="decalage_j" value="{{decalage_j}}" /> jours 
        <button onclick="changelePas(-1);return(false)">-</button>
        <button onclick="changelePas(1);return(false)">+</button>
        <br/>
         <input type="radio" name="periode" value="annee" {% if periode == "annee" %}checked{% endif %}>Cette année
         <input type="radio" name="periode" value="mois" {% if periode == 'mois' %}checked{% endif %}>Ce mois
         <input type="radio" name="periode" value="semaine" {% if periode == 'semaine' %}checked{% endif %}>Cette semaine
         <input type="radio" name="periode" value="specifique" {% if periode == 'specifique' %}checked{% endif %}>Spécifique
         du <input style="width: 100px" type="text" name="date_debut_vue" value="{{date_debut_vue|date:'d/m/Y'}}" /> 
         au <input style="width: 100px" type="text" name="date_fin_vue" value="{{date_fin_vue|date:'d/m/Y'}}" />
        <br/>
        <input type="radio" name="detail" value="espece" onclick="montre_especes()" checked >Regroupé par espèce
        <input type="radio" name="detail" value="legume" onclick="montre_legumes()" >Détaillé par légume
        <input name="bSerres" type="checkbox" {% if bSerres %}checked{% endif %} /> Serres 
        <input name="bChamps" type="checkbox" {% if bChamps %}checked{% endif %} /> Champs 
        <input style="margin-left: 20px" type="submit" value="Envoyer" />
        <input style="margin-left: 10px" type="submit" name="direction" value="recul" />
        <input type="submit" name="direction" value="avance" /> 
    </div>    
    </form>
    <br/>
    
    <table border="1" id="tab_legumes" >
        <tr><th>Légumes/Semaines</th>
            {% for semaine in l_semaines %}
                <td align="center">Semaine {{semaine.date_debut_sem_iso}}<br/>du {{semaine.date_debut|date:'d/m/Y'}}<br/>au {{semaine.date_fin|date:'d/m/Y'}}</td>
            {% endfor %}
            <th align="center">Total (kg)</th>
        </tr>
        
        <!-- tab légumes -->
        {% for leg in l_legumes %}
        <tr>
            <td><small>{{leg.nom|title}} ({{leg.espece.nomUniteProd}})</small></td>
            
            {% for t_prod in leg.l_prod %}
            <td>{{t_prod.0|date:'d/m/Y'}}<br/>
                <div id="sem_{{t_prod.0|date:'Y-m-d'}}__leg_{{leg.id}}"
                        esp_id="{{leg.espece.id}}"
                        esp_nom="{{leg.espece.nom}}"
                        qte="{{t_prod.1}}" 
                        poids="{{t_prod.2}}" 
                        style="border:5px solid {{t_prod.4}}">Estimé : {{t_prod.1}}</div>
                
                Réel<input  type="text"
                        name="reel"
                        style="width:30px;font-weight:bold;text-align: center" 
                        id="r__sem_{{t_prod.0|date:'Y-m-d'}}__leg_{{leg.id}}"
                        value="{{t_prod.5}}" />
    
                <img    src="{% static 'images/ok.png' %}" 
                        style="width:15px;heigth:15px;cursor:pointer"
                        date="{{t_prod.0|date:'Y-m-d'}}"
                        leg="{{leg.id}}"
                        title="Valider"
                        onmouseover=""
                        onclick="enregistreRecolte(this);return(false)"
                        />
            </td>
            {% endfor %}
            <td><div style="font-weight:bold;text-align: center" id="tl_{{leg.id}}"> </div></td>
        </tr>
        {% endfor %}
        

        <tr>
            <th>Total estimé (kg)</th>{# ligne de total des qte de legumes par semaine #}
        {% for semaine in l_semaines %}
            <td><div style="font-weight:bold;text-align:center" id="ts_{{semaine.date_debut|date:'Y-m-d'}}"> </div></td>
        {% endfor %}

        <td><div id="totalTotal" style="font-weight:bold;text-align:center"> </div></td>
        </tr>
        
        <tr><th>Total (kg) par pannier</th>{# ligne de total des qte de legumes par semaine #}
        {% for semaine in l_semaines %}
        <td><div style="font-weight:bold;text-align:center" id="tlpp_{{semaine.date_debut|date:'Y-m-d'}}"> </div></td>
        {% endfor %}

        <td><div id="totalTotal" style="font-weight:bold;text-align:center"> </div></td>
        </tr>        
    </table>
    
    <p> </p>
    
    <!------------------- tableau par especes -------------------------->
    
    <table border="1" id="tab_especes" >
        <tr><th>Espèces/Semaines</th>
            {% for semaine in l_semaines %}
                <td align="center">Semaine {{semaine.date_debut_sem_iso}}<br/>du {{semaine.date_debut|date:'d/m/Y'}}<br/>au {{semaine.date_fin|date:'d/m/Y'}}</td>
            {% endfor %}
            <th align="center">Total (kg)</th>
        </tr>
        
        {% for esp in l_especes %}
        <tr>
            <td style="width:200px"><small>{{esp.nom|title}} ({{esp.nomUniteProd}})</small></td>
            
            {% for semaine in l_semaines %}            
            <td>{{semaine.date_debut|date:'d/m/Y'}}<br/>
            <small><div id="sem_{{semaine.date_debut|date:'Y-m-d'}}__esp_{{esp.id}}"></div></small>    
            </td>
            {% endfor %}
            <td><div style="font-weight:bold;text-align: center" id="tets_{{esp.id}}"> </div></td>
        </tr>
        {% endfor %}
        

        <tr><th>Total (kg)</th>{# ligne de total des quantités de l'espece par semaine #}
        {% for semaine in l_semaines %}
        <td><div style="font-weight:bold;text-align:center" id="tets_{{semaine.date_debut|date:'Y-m-d'}}"> </div></td>
        {% endfor %}
        <td id="total_etets" style="font-weight:bold;text-align:center"> </td>
        </tr>
        
        <tr><th>Total (kg) par pannier</th>{# ligne de total des qte par pannier, par espece et par semaine #}
        {% for semaine in l_semaines %}
        <td style="font-weight:bold;text-align:center" id="tepspp_{{semaine.date_debut|date:'Y-m-d'}}" > </td>
        {% endfor %}
        <td id="total_etspp" style="font-weight:bold;text-align:center"> </td>
        </tr>   
        
        <tr><th>Contenu des panniers</th>
        {% for semaine in l_semaines %}
        <td style="font-weight:bold;text-align:left" id="cont_pspp_{{semaine.date_debut|date:'Y-m-d'}}" > </td>
        {% endfor %}
        <td> </td>
        </tr>  
    </table>
    
        
{% endblock %}
